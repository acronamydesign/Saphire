var saphireApi = require("saphire").functions,
		saphireTemplate = saphireApi.template,
		saphireData = require("saphire").data,
		saphireModels = saphireData.models,
		mongoose = saphireApi.db.mongoose

var menuModelParent = saphireModels[2].menu,
		blocksModel = saphireModels[0].blocks;


module.exports = function(templateMarkup){

	function getData(name){
		 var promise = menuModelParent.find().exec();
		 return promise;
	}
	var promise = getData();
	promise
	.then(function(data){
		var adminMenu = data[0].adminMenu

		//sort by index number
		adminMenu.sort(function(a, b){
		 return a.index-b.index
		})

		return adminMenu;
	})
	.then(function(menu){
		var menu = menu.filter(Boolean)
		var menuWrap = []
		for(menuItem in menu){
			var menuItem = menu[menuItem];

			if(menuItem.friendlyName == "admin") var href = '/'+menuItem.friendlyName;
			else var href = '/admin/'+menuItem.friendlyName;

			var links = saphireTemplate.htmlEl("a",menuItem.friendlyName,{
				href:href,
				title:menuItem.friendlyName
			})
			menuWrap.push("<li>"+links+"</li>")

		}
		return menuWrap;
	})
	.then(function(links){
		var menuItemsCompiled = links.toString().split(",").join("");
		//inject our menu using our special interpolation @{key} in jade
		var markup = saphireTemplate.inject(templateMarkup, {
			"navItems":menuItemsCompiled
		});

		var block = new blocksModel({
			machineName:"admin_menu",
			name:"Admin Menu",
			description:"Foxie admin menu block, menu items generated for cores package.json file.",
			title:"Admin menu",
			content:markup,
			enabled:true,
			origin:"core"
		});

		saphireApi.queryGate(blocksModel,function(){
			block.save(function (err) {
				if (err) return console.log("error:", err.message)
			})
		});
	});

}
