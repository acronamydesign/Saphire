//Master file
var saphireGlobals = require("./globals.js")


//get all saphire dependencies and build a registery array for admin

function loadMainPackageJSON(attempts) {
	attempts = attempts || 1;
	if (attempts > 5) {
		throw new Error('Can\'t resolve main package.json file');
	}
	var mainPath = attempts === 1 ? './' : Array(attempts).join("../");
	try {
		return require.main.require(mainPath + 'package.json');
	} catch (e) {
		return loadMainPackageJSON(attempts + 1).parseJSON();
	}
}

var mainPackageJSON = loadMainPackageJSON();

var saphireRegistry = [];
var i = 0;
for(deps in mainPackageJSON["dependencies"]){
	if(/saphire/g.test(deps)){

		//Version
		var version = mainPackageJSON["dependencies"][deps].split("^").join("")

		//concat
		saphireRegistry.push(deps+":"+version)
	}
}

var purposes = []
for(item in saphireRegistry){
	var item = saphireRegistry[item].replace("saphire-","");
	purposes.push(item)
}

var adminMenu = {}
for(item in purposes){
	var data = purposes[item].split(":");
	var saphireModuleName = data[0]
	var saphireModuleVersion = data[1];
	adminMenu[saphireModuleName] = {
		name:saphireModuleName,
		version:saphireModuleVersion,
		menuEntry:{
			title:saphireModuleName.charAt(0).toUpperCase()+saphireModuleName.slice(1),
			href:"admin/"+saphireModuleName
		}
	}
}

//tidy up
delete adminMenu["saphire"]["menuEntry"]
delete adminMenu["admin"]["menuEntry"]

//add extras - will change themes to its own module soon

adminMenu["dashboard"] = {
	name:"dashboard",
	adminIndex:true,
	menuEntry:{
		title:"Dashboard",
		href:"admin/dashboard"
	}
}
if(adminMenu["regions"]){
	adminMenu["appearance"] = {
		name:"appearance",
		menuEntry:{
			title:"Appearance",
			href:"admin/appearance"
		}
	}
}


module.exports = adminMenu;
