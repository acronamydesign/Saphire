//Async

var saphireApi = require("saphire").functions,
		saphireData = require("saphire").data,
		Q = require("q"),
		fs = require("fs"),
		gulp = require("gulp"),
		concat = require('gulp-concat'),
		uglify = require('gulp-uglify'),
		path = require("path");

	var themePath = saphireApi.useData("temp",saphireData.publicPath),
			systemLibPath = path.resolve(__dirname,"../../../saphire-themes/system/libraries");

var settings = {
	compress:true,
}

function afterDir(path){ //[3]
	//must exec inside async, sadly
	var lib = require('bower-files')({
			dir:themePath+"libraries/bower/",
			cwd:themePath+"libraries/"
	});

	gulp.task("default",function(){ //Make gulp pipe the libraries files into the actual system rendered templates dir (saphire_themes)
		//console.log(lib.ext('js').files)
		gulp.src(lib.ext('js').files)
			.pipe(concat('lib.min.js'))
			.pipe(uglify())
			.pipe(gulp.dest(systemLibPath));
	});
	gulp.start("default");
}
function bowerSetup(path){ //[3 or skiped]
	var bowerJson = {
		"name": "Foxie-libraries",
		"version": "0.0.1",
		"dependencies": {},
		"private": true
	}
	var bowerRc = {
		"directory": "bower/",
		"analytics": false,
		"timeout": 120000,
	}
	function writeRc(path){
		fs.writeFile(themePath+"libraries/.bowerrc", JSON.stringify(bowerRc, null, "\t"), function(err){
			if(err) console.log(err)
			afterDir(path) //move on
		});
	}
	function writeJson(path){
		fs.writeFile(themePath+"libraries/bower.json", JSON.stringify(bowerJson, null, "\t"), function(err){
			if(err) console.log(err)
			writeRc(path)
		});
	}
	//start writing
	writeJson(path)
}
function makeDir(err,path){ //[2]
	if(err) fs.mkdir(path, function(err){
		if(!err || (err && err.code === 'EEXIST')){
				//setting up bower for first time
				bowerSetup(path)
				console.log("Setting up bower at '"+themePath+"libraries' for the first time.")
		} else {
				console.log(err);
		}
	});
}
function testDir(path){ //[1]
	fs.readdir(path, function(err,dir){
		//doesnt exist so make it
		if(err) makeDir(err, path)
		//does exist skip
		if(!err) afterDir(path)
	})
}
//main call
(function dir(path){ //[0]
	testDir(path)
})(themePath+"libraries")
