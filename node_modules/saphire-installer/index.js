//for sucurity purposes we have hard coded the installer into another module, this module will overide all routes enabling the install to take place, once prompted, please uninstall the installer package or deleate it entirely.

var colors = require("colors"),
	saphireExpose = {
		functions: require("saphire").functions
	}

//reasign exposed saphire dependencies
var bodyParser = saphireExpose.functions.bodyParser(),
	mongoose = saphireExpose.functions.db.mongoose,
	toSaphire = saphireExpose.functions.db.toSaphire;

//exporting
var exportable = [],
	saphire = {}

saphire.install = function (app) {

	//body parser
	var urlencodedParser = bodyParser.urlencoded({
		extended: false
	});
	var jsonParser = bodyParser.json();
	app.use(urlencodedParser)
	app.use(jsonParser)

	//express
	app.use('/install/css', express.static(__dirname + '/install-views/styles/'));
	app.set('views', __dirname + '/install-views');

	//mongoose
	mongoose.connect(toSaphire)
	var db = mongoose.connection,
		schema = mongoose.Schema;
	db.on('error', function (err) {
		console.log('connection error'.red, err);
	});
	db.once('open', function () {
		console.log('connected to mongoose.'.green);
	});

	//models
	var users = require('./models/user.js'),
		status = require('./models/state.js'),
		site = require('./models/site.js');

	//routes
	var blocking = require("./routes/blocking.js");
	var installSequence = require("./routes/install-sequence.js");
	var installForm = require("./routes/install-form.js");



	status.find({installed: true}, function (err,results) {

			//secure check
			if (results.length) {
				console.log("[Warning] \nSaphire is already installed! Please remove the installer package, run 'npm uninstall saphire-installer'!".red)
				app.get("/install", function(req,res){
					res.render("done.jade", {data:{
						messageHeading:"Try again",
						message:"You have restarted the node server, however to secure this website, please remove the installer package, run: 'npm uninstall saphire-installer'.",
						state:false
					}})
				});
				app.get("/", function(req,res){
					res.render("done.jade", {data: {
						messageHeading:"Try again",
						message:"You have restarted the node server, however to secure this website, please remove the installer package, run: 'npm uninstall saphire-installer'.",
						state:false
					}})
				});
				app.get("/done", function(req,res){
					res.render("done.jade", {data:{
						messageHeading:"Try again",
						message:"You have restarted the node server, however to secure this website, please remove the installer package, run: 'npm uninstall saphire-installer'.",
						state:false
					}})
				});
			} else {
				console.log("Ready to install saphire, start the server.".blue)
				//3 stage install sequence.
				installSequence(app);
				//stop access to admin.
				blocking(app);
				//install form
				installForm(app, urlencodedParser, [users, status, site]);
			}

	});

}

exportable.push(saphire)
module.exports = exportable;
